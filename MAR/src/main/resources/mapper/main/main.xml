<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sist.mar.main">

	<sql id="listOut">
		<choose>
			<when test=" '10' == listDiv "><!-- 카테고리별목록10 -->
				AND t1.category_no= #{categoryNo}
				ORDER BY t1.reg_dt desc
			</when>
			<when test=" '20' == listDiv "><!-- 신상품목록20 -->
				ORDER BY t1.reg_dt desc
			</when>
			<when test=" '30' == listDiv "><!-- 베스트목록30 -->
				ORDER BY t1.sales desc
			</when>
			<when test=" '40' == listDiv "><!-- 이벤트목록40-->
				AND NOT t1.discount IS NULL
				AND NOT t1.discount = 0
	    		ORDER BY t1.reg_dt desc
			</when>
		</choose>
	</sql>

	<select id="doRetrieve" parameterType="CateSearchVO" resultType="MainVO">
		SELECT A.*,B.*
		FROM(
		    SELECT g2.rnum as num,
		           g2.path,
		           g2.name,
		           g2.discount,
		           g2.price,
		           g2.final_price as finalPrice,
		           g2.sales
		    FROM(
		    SELECT ROWNUM rnum,g1.*
		    FROM(SELECT t2.path || t2.save_name AS path,
		            t1.name,
		            t1.discount,
		            t1.price,
		            t1.final_price, 
		            t1.sales
		    FROM item t1, image t2
		    WHERE t1.item_no=t2.from_no
		    AND t2.main_image = 1
		    AND t2.from_tb=1
		    --listOut 구분
		    <include refid="listOut"/>
		    )g1
		    <![CDATA[
		    WHERE ROWNUM <= (#{pageSize}*(#{pageNum}-1)+#{pageSize})  
		    )g2
		    WHERE rnum >= (#{pageSize}*(#{pageNum}-1)+1)
		    ]]>   
		)A CROSS JOIN(
		    SELECT COUNT(*) totalCnt
		    FROM item
		)B
		--검색 조회
		WHERE name LIKE '%'||#{searchWord}||'%'
	</select>
	
</mapper>

